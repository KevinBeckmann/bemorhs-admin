<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>iPlay Store - Painel do Administrador</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <meta name="theme-color" content="#6eea70">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="iPlay Admin">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Firebase SDK (Com Autentica√ß√£o e Firestore) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      getDoc,
      updateDoc,
      deleteDoc,
      doc,
      setDoc,
      writeBatch,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZPIYOFtfmYEeeHGOCqzHsV1a206n0-cQ",
      authDomain: "iplay-65220.firebaseapp.com",
      projectId: "iplay-65220",
      storageBucket: "iplay-65220.firebasestorage.app",
      messagingSenderId: "264955612573",
      appId: "1:264955612573:web:f5a8b2c548962f6b7d7374",
      measurementId: "G-7MC7673WPH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // =============================
    // FIRESTORE: PRODUTOS + CONFIG
    // =============================

    window.salvarProdutosFirestore = async function(produtos) {
      const batch = writeBatch(db);

      (produtos || []).forEach((p) => {
        const id = String(p.id ?? '');
        if (!id) return;
        const ref = doc(db, "produtos", id);

        batch.set(ref, {
          id: Number(p.id) || 0,
          nome: p.nome || "",
          cat: p.cat || "aparelhos",
          preco: Number(p.preco) || 0,
          desc: p.desc || "",
          img: p.img || "",
          featured: !!p.featured,
          updatedAt: serverTimestamp()
        }, { merge: true });
      });

      await batch.commit();
      return true;
    };

    // ‚úÖ NOVO: excluir 1 produto direto no Firestore
    window.excluirProdutoFirestore = async function(id) {
      const pid = String(id ?? '').trim();
      if (!pid) throw new Error("ID inv√°lido");
      await deleteDoc(doc(db, "produtos", pid));
      return true;
    };

    window.carregarProdutosFirestore = async function() {
      const snap = await getDocs(collection(db, "produtos"));
      const lista = snap.docs.map(d => ({ idDoc: d.id, ...d.data() }));
      lista.sort((a, b) => (Number(a.id) || 0) - (Number(b.id) || 0));
      return lista;
    };

    window.salvarConfigFirestore = async function(pagamento, promocoes) {
      const pagamentoRef = doc(db, "config", "pagamento");
      const promocoesRef = doc(db, "config", "promocoes");

      await setDoc(pagamentoRef, {
        credito: (pagamento?.credito || "").trim(),
        whatsapp: (pagamento?.whatsapp || "").trim(),
        updatedAt: serverTimestamp()
      }, { merge: true });

      await setDoc(promocoesRef, {
        items: Array.isArray(promocoes) ? promocoes.map(s => String(s || '').trim()).filter(Boolean) : [],
        updatedAt: serverTimestamp()
      }, { merge: true });

      return true;
    };

    window.carregarPagamentoFirestore = async function() {
      const pagamentoRef = doc(db, "config", "pagamento");
      const snap = await getDoc(pagamentoRef);
      if (!snap.exists()) return { credito: "", whatsapp: "" };
      const data = snap.data() || {};
      return { credito: String(data.credito || ""), whatsapp: String(data.whatsapp || "") };
    };

    window.carregarPromocoesFirestore = async function() {
      const promocoesRef = doc(db, "config", "promocoes");
      const snap = await getDoc(promocoesRef);
      if (!snap.exists()) return [];
      const data = snap.data() || {};
      return Array.isArray(data.items) ? data.items : [];
    };

    // --- LOGIN ---
    window.fazerLoginFirebase = async function(email, senha) {
      await signInWithEmailAndPassword(auth, email, senha);
    };

    window.fazerLogout = async function() {
      await signOut(auth);
      window.location.reload();
    };

    onAuthStateChanged(auth, (user) => {
      const loginScreen = document.getElementById('loginScreen');
      const mainContent = document.getElementById('mainContent');

      if (user) {
        if (loginScreen) loginScreen.style.display = 'none';
        if (mainContent) mainContent.style.display = 'block';
        if (window.carregarTudo) window.carregarTudo();
        console.log("Admin logado:", user.email);
      } else {
        if (loginScreen) loginScreen.style.display = 'flex';
        if (mainContent) mainContent.style.display = 'none';
      }
    });

    // --- PEDIDOS ---
    window.carregarPedidosFirebase = async function() {
      const snapshot = await getDocs(collection(db, "pedidos"));
      const lista = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      return lista.sort((a,b) => {
        const ta = a?.timestamp?.seconds || 0;
        const tb = b?.timestamp?.seconds || 0;
        return tb - ta;
      });
    };

    window.atualizarStatusFirebase = async function(id, novoStatus) {
      await updateDoc(doc(db, "pedidos", id), { status: novoStatus });
    };

    window.excluirPedidoFirebase = async function(id) {
      await deleteDoc(doc(db, "pedidos", id));
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

    :root {
      --bg-body: #0b0c10;
      --bg-card: #1a1c20;
      --bg-elev: #1e2126;
      --accent: #6eea70;
      --text: #ffffff;
      --text-dim: #a1a1a1;
      --border: rgba(255,255,255,0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Inter', sans-serif;
      background: #08090b;
      color: var(--text);
      min-height: 100vh;
      background-image:
        radial-gradient(circle at 50% 0%, rgba(20,24,30,0.9) 0%, rgba(8,9,11,1) 80%),
        url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-27-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm-24-4c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM0 10c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm77 3c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1zM50 0c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zm35 77c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM98 40c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM14 74c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zM62 8c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM85 62c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM47 54c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM28 89c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM78 4c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM38 36c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM52 18c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zM25 64c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM90 43c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM16 56c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6zM37 46c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM7 24c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM21 54c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM32 40c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM41 84c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM58 78c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM75 14c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM66 66c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM3 50c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM19 80c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM33 2c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zM87 34c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM13 26c3.314 0 6-2.686 6-6s-2.686-6-6-6-6 2.686-6 6 2.686 6 6 6z' fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
      background-size: cover, 400px 400px;
    }

    #loginScreen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: #08090b; z-index: 9999;
      display: flex; justify-content: center; align-items: center; flex-direction: column;
      padding: 20px;
    }
    .login-box {
      background: var(--bg-card); padding: 30px; border-radius: 16px; border: 1px solid var(--border);
      text-align: center; max-width: 400px; width: 100%;
      box-shadow: 0 0 40px rgba(0,0,0,0.5);
    }
    .login-box h2 { margin-bottom: 20px; color: var(--accent); }
    .login-box input {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333;
      background: #0b0c10; color: #fff; margin-bottom: 15px; font-size: 1rem;
      text-align: center;
    }
    .login-box button { width: 100%; }

    #mainContent { display: none; }

    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(8, 9, 11, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .header-container {
      max-width: 1200px; margin: 0 auto; padding: 12px 20px;
      display: flex; align-items: center; gap: 16px; justify-content: space-between;
      flex-wrap: wrap;
    }
    .brand { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 250px; }
    .logo { width: 42px; height: 42px; flex-shrink: 0; }
    .title { font-weight: 700; font-size: 1.1rem; line-height: 1.2; }
    .hint { color: var(--text-dim); font-size: 0.8rem; margin-top: 2px; }

    .container {
      max-width: 1200px; margin: 20px auto; padding: 0 20px; display: grid; gap: 20px;
      grid-template-columns: 1fr 350px;
      align-items: start;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.3);
    }
    .card h2 {
      font-size: 1.05rem; margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
      color: #fff; font-weight: 700;
    }

    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
    button, .btn {
      background: var(--accent); color: #000; border: none; border-radius: 8px;
      padding: 12px 16px; font-weight: 700; cursor:pointer; font-size: 0.9rem;
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      text-decoration: none; transition: 0.2s;
    }
    button:active, .btn:active { transform: scale(0.96); }
    button.secondary { background: #2a2f35; color: #fff; border: 1px solid var(--border); }
    button.danger { background: #ff5555; color: #000; }

    .field { display: grid; gap: 6px; margin-bottom: 12px; }
    .field label { color: #ccc; font-size: 0.85rem; }
    .field input, .field select, .field textarea {
      background: #0b0c10; border: 1px solid #333; color: #fff; border-radius: 8px;
      padding: 12px; font-size: 1rem; width: 100%;
    }
    .two-cols { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }

    .product-item {
      background: var(--bg-elev);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      display: grid; gap: 12px;
    }
    .product-head {
      display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;
    }
    .head-title { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px; }
    .head-actions { display: flex; gap: 6px; }

    .badge {
      background: rgba(110,234,112,0.15);
      border: 1px solid rgba(110,234,112,0.3);
      color: var(--accent); font-weight: 700; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem;
    }

    .product-grid { display: grid; gap: 15px; grid-template-columns: 1.5fr 1fr; align-items: start; }
    .img-preview {
      width: 100%; max-width: 200px; height: auto;
      border-radius: 8px; border: 1px solid #333; background: #fff; padding: 4px;
      margin-top: 10px;
    }

    .upload-row { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .upload-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; }
    .upload-actions .btn { padding: 8px 12px; font-size: 0.8rem; }

    .promo-item {
      background: var(--bg-elev);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      display: grid;
      gap: 10px;
    }
    .promo-preview {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #333;
      padding: 4px;
      background: #fff;
    }

    .aside .card { position: static; }
    @media (min-width: 901px) {
      .aside {
        position: sticky;
        top: 94px;
        align-self: start;
      }
    }

    .small { font-size: 0.8rem; color: #888; margin-top: 5px; line-height: 1.4; }
    .footer-note { text-align: center; color: #555; font-size: 0.8rem; padding: 20px 0 40px; }

    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; padding: 0 15px; margin-top: 15px; }
      .product-grid { grid-template-columns: 1fr; }

      .header-container { padding: 10px 15px; flex-direction: column; align-items: stretch; gap: 12px; }
      .header-container .btn { width: 100%; }
      .title { font-size: 1rem; }
      .hint { display: none; }

      .toolbar button, .toolbar label.btn { flex: 1; padding: 14px; text-align: center; }
      .head-actions button { padding: 8px 12px; }

      .two-cols { grid-template-columns: 1fr; }
      .upload-actions .btn { width: 100%; }
      .img-preview { max-width: 100%; height: 200px; object-fit: contain; background: #222; }
    }

    .pedido-item {
      background: var(--bg-elev);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      display: grid; gap: 12px;
    }
    .pedido-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .pedido-info { font-size: 0.9rem; color: var(--text-dim); }
    .pedido-status {
      padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;
      background: #ff5555; color: #000;
    }
    .pedido-status.atendido { background: var(--accent); }

    #installPrompt {
      display:none;
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      z-index:11000;
      background:var(--bg-card);
      border:1px solid var(--border);
      padding:12px;
      border-radius:14px;
      width:min(420px, calc(100% - 24px));
      box-shadow:0 10px 24px rgba(0,0,0,0.4);
    }
    #installPrompt .row {
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:10px;
    }
    #installPrompt button { padding:10px 12px; }
  </style>
</head>

<body>

  <!-- TELA DE LOGIN -->
  <div id="loginScreen">
    <div class="login-box">
      <i class="fa-solid fa-user-shield" style="font-size:40px; color:var(--acc); margin-bottom:15px;"></i>
      <h2>Acesso Admin Seguro</h2>
      <input type="email" id="emailInput" placeholder="Seu E-mail" style="margin-bottom:10px;">
      <input type="password" id="passInput" placeholder="Sua Senha">
      <button class="btn-primary" onclick="loginReal()">ENTRAR</button>
      <p id="loginMsg" style="color:#ff4444; margin-top:10px; display:none; font-size:0.9rem;"></p>
    </div>
  </div>

  <!-- CONTE√öDO DO PAINEL -->
  <div id="mainContent">
    <header>
      <div class="header-container">
        <div class="brand">
          <img class="logo" src="imagem.logo.png" alt="Logo">
          <div>
            <div class="title">IPLAY | Administrador </div>
            <div class="hint">Gerencie produtos e configura√ß√µes da loja.</div>
          </div>
        </div>

        <a class="btn" id="btnVerLoja" href="COLE_AQUI_O_LINK_DA_SUA_LOJA" target="_blank" rel="noopener">
          <i class="fa-solid fa-up-right-from-square"></i> Ver Loja
        </a>
      </div>
    </header>

    <main class="container">
      <section class="card">
        <h2><i class="fa-solid fa-box"></i> Gerenciar Produtos</h2>
        <div class="toolbar">
          <button id="btnAdd"><i class="fa-solid fa-plus"></i> Adicionar</button>
          <button id="btnSave"><i class="fa-solid fa-floppy-disk"></i> Salvar Tudo</button>
          <button id="btnReset" class="secondary"><i class="fa-solid fa-rotate-left"></i> Resetar</button>
        </div>
        <div id="productsList" class="list"></div>
      </section>

      <aside class="aside">
        <section class="card">
          <h2><i class="fa-solid fa-receipt"></i> Compras Realizadas</h2>
          <div class="toolbar">
            <button id="btnLoadPedidos"><i class="fa-solid fa-sync"></i> Carregar Compras</button>
          </div>
          <div id="pedidosList"></div>
          <div class="small" style="text-align:center;"> <code></code> </div>
        </section>

        <section class="card" style="margin-top:14px;">
          <h2><i class="fa-solid fa-images"></i> Promo√ß√µes</h2>
          <div class="toolbar">
            <button id="btnAddPromo"><i class="fa-solid fa-plus"></i> Adicionar</button>
            <button id="btnSavePromo"><i class="fa-solid fa-floppy-disk"></i> Salvar</button>
            <button id="btnResetPromo" class="secondary"><i class="fa-solid fa-rotate-left"></i> Resetar</button>
          </div>
          <div id="promocoesList"></div>
          <div class="small" style="text-align:center;">(<b></b> <code></code>)</div>
        </section>

        <section class="card" style="margin-top:14px;">
          <h2><i class="fa-solid fa-credit-card"></i> Pagamento</h2>
          <div class="field">
            <label for="credito" style="color:var(--accent);">Link de Pagamento (Mercado Pago)</label>
            <input id="credito" type="url" placeholder="Cole aqui seu link de pagamento...">
            <small style="color:#777; font-size:0.75rem;"></small>
          </div>
        </section>

        <section class="card" style="margin-top:14px;">
          <h2><i class="fa-brands fa-whatsapp"></i> WhatsApp</h2>
          <div class="field">
            <label for="whatsapp">N√∫mero (somente n√∫meros, com DDD)</label>
            <input id="whatsapp" type="tel" placeholder="5599999999999">
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button id="btnSavePay" style="width:100%"><i class="fa-solid fa-floppy-disk"></i> Salvar Configura√ß√µes</button>
          </div>
          <div class="small" style="text-align:center;"> <b></b> <code></code> </div>
        </section>

        <section class="card" style="margin-top:14px;">
          <h2><i class="fa-solid fa-file-export"></i> Backup</h2>
          <div class="toolbar" style="flex-direction: column;">
            <button id="btnExport" class="secondary" style="width:100%"><i class="fa-solid fa-download"></i> Baixar Backup</button>
            <label class="btn secondary" for="fileImport" style="width:100%; cursor: pointer;">
              <i class="fa-solid fa-upload"></i> Restaurar Backup
              <input id="fileImport" type="file" accept="application/json" style="display:none;">
            </label>
          </div>
          <div class="small" style="text-align: center;"></div>
        </section>
      </aside>
    </main>

    <div class="footer-note">Painel Admin Mobile ‚Ä¢ iPlay Store</div>
  </div>

  <!-- Install prompt UI -->
  <div id="installPrompt">
    <div style="color:#fff;font-weight:700">Instalar o app no seu dispositivo?</div>
    <div class="small"></div>
    <div class="row">
      <button id="btnCancelInstall" class="secondary" type="button">Depois</button>
      <button id="btnInstall" type="button">Instalar</button>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Admin-Iplay/sw.js')
          .then(() => console.log('Service Worker registrado'))
          .catch(err => console.warn('Erro registrando SW', err));
      });
    }

    function isRunningStandalone(){
      return (
        window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true
      );
    }

    if (isRunningStandalone()) {
      const el = document.getElementById('installPrompt');
      if (el) el.style.display = 'none';
    }

    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      if (isRunningStandalone()) return;
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installPrompt').style.display = 'block';
    });

    document.getElementById('btnInstall').addEventListener('click', async () => {
      document.getElementById('installPrompt').style.display = 'none';
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    });

    document.getElementById('btnCancelInstall').addEventListener('click', () => {
      document.getElementById('installPrompt').style.display = 'none';
    });

    window.addEventListener('appinstalled', () => {
      deferredPrompt = null;
      document.getElementById('installPrompt').style.display = 'none';
    });
  </script>

  <script>
    // --- 1. AUTENTICA√á√ÉO REAL (Firebase) ---
    async function loginReal() {
      const email = document.getElementById('emailInput').value;
      const pass = document.getElementById('passInput').value;
      const msg = document.getElementById('loginMsg');

      if(msg) {
        msg.style.display = 'block';
        msg.innerText = "Entrando...";
        msg.style.color = "#ccc";
      }

      try {
        if (window.fazerLoginFirebase) {
          await window.fazerLoginFirebase(email, pass);
        } else {
          alert("Erro: Firebase n√£o carregou. Recarregue a p√°gina.");
        }
      } catch (error) {
        if(msg) {
          msg.style.color = "#ff4444";
          if(error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
            msg.innerText = "E-mail ou senha incorretos.";
          } else if (error.code === 'auth/too-many-requests') {
            msg.innerText = "Muitas tentativas. Aguarde um pouco.";
          } else {
            msg.innerText = "Erro ao entrar (" + error.code + ")";
          }
        }
      }
    }

    document.getElementById('passInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') loginReal();
    });

    // --- SISTEMA DO ADMIN ---
    const LS_KEYS = {
      produtos: 'iplay.produtos',
      pagamento: 'iplay.pagamento',
      promocoes: 'iplay.promocoes'
    };

    const defaultProdutos = [
      { id: 1, nome: "iPhone 15 Pro Max", cat: "aparelhos", preco: 8299, desc: "1TB Titanium Natural", img: "https://images.unsplash.com/photo-1695822822491-d92cee704368?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.0.3", featured: false },
      { id: 2, nome: "MacBook Pro M3", cat: "aparelhos", preco: 12599, desc: "512GB Space Black", img: "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=500&q=80", featured: false },
      { id: 3, nome: "MacBook Pro 16\"", cat: "aparelhos", preco: 14999, desc: "1TB Silver M3 Max", img: "https://images.unsplash.com/photo-1611186871348-b1ce696e52c9?auto=format&fit=crop&w=500&q=80", featured: false },
      { id: 4, nome: "AirPods Pro 2", cat: "fones", preco: 1899, desc: "USB-C MagSafe Case", img: "https://images.unsplash.com/photo-1588156979435-379b9d802b74?auto=format&fit=crop&w=400&q=80", featured: false },
      { id: 5, nome: "Apple Watch Ultra 2", cat: "aparelhos", preco: 6299, desc: "Titanium Case 49mm", img: "https://images.unsplash.com/photo-1549439602-43ebca2327af?auto=format&fit=crop&w=400&q=80", featured: false },
      { id: 6, nome: "Carregador MagSafe", cat: "carregadores", preco: 399, desc: "Original Apple 15W", img: "https://images.unsplash.com/photo-1583863788434-e58a36330cf0?auto=format&fit=crop&w=400&q=80", featured: false },
      { id: 7, nome: "Apple Pencil 2", cat: "aparelhos", preco: 899, desc: "Magn√©tica para iPad", img: "https://images.unsplash.com/photo-1557858310-9052820906f7?auto=format&fit=crop&w=400&q=80", featured: false },
      { id: 8, nome: "HomePod Mini", cat: "aparelhos", preco: 799, desc: "Smart Speaker White", img: "https://images.unsplash.com/photo-1596558450255-7c0b7be9d56a?auto=format&fit=crop&w=400&q=80", featured: false }
    ];

    const defaultPagamento = { credito: "", whatsapp: "" };

    const defaultPromocoes = [
      "https://images.unsplash.com/photo-1695822822491-d92cee704368?w=600&auto=format&fit=crop&q=80",
      "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=500&q=80",
      "https://images.unsplash.com/photo-1611186871348-b1ce696e52c9?auto=format&fit=crop&w=500&q=80"
    ];

    let produtos = [];
    let pagamento = {};
    let promocoes = [];

    function loadState() {
      try {
        const p = JSON.parse(localStorage.getItem(LS_KEYS.produtos) || 'null');
        const pay = JSON.parse(localStorage.getItem(LS_KEYS.pagamento) || 'null');
        const promo = JSON.parse(localStorage.getItem(LS_KEYS.promocoes) || 'null');

        produtos = Array.isArray(p) && p.length ? p : defaultProdutos.slice();
        pagamento = pay && typeof pay === 'object' ? { ...defaultPagamento, ...pay } : { ...defaultPagamento };
        promocoes = Array.isArray(promo) && promo.length ? promo : defaultPromocoes.slice();
      } catch {
        produtos = defaultProdutos.slice();
        pagamento = { ...defaultPagamento };
        promocoes = defaultPromocoes.slice();
      }
    }

    function toast(msg) {
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); border:1px solid #6eea70; color:#fff; padding:12px 20px; border-radius:30px; z-index:10000;";
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2000);
    }

    function saveProdutosToLS() {
      try {
        localStorage.setItem(LS_KEYS.produtos, JSON.stringify(produtos));
        toast("Produtos salvos (local)!");
      } catch (err) {
        console.error(err);
        alert('Erro ao salvar. Espa√ßo cheio? Tente usar imagens menores.');
      }
    }

    function savePagamentoToLS() {
      try {
        localStorage.setItem(LS_KEYS.pagamento, JSON.stringify(pagamento));
        toast("Configura√ß√µes salvas (local)!");
      } catch (err) {
        alert('Erro ao salvar config.');
      }
    }

    function savePromocoesToLS() {
      try {
        promocoes = (promocoes || []).map(s => String(s || '').trim()).filter(Boolean);
        localStorage.setItem(LS_KEYS.promocoes, JSON.stringify(promocoes));
        toast("Promo√ß√µes salvas (local)!");
      } catch (err) {
        console.error(err);
        alert('Erro ao salvar promo√ß√µes. Espa√ßo cheio? Use imagens menores.');
      }
    }

    function escapeHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function escapeAttr(s) { return String(s || '').replace(/"/g,'&quot;'); }

    function fileToDataUrlCompressed(file, maxSize = 800, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const img = new Image();
          img.onload = () => {
            let { width, height } = img;
            const ratio = width / height;
            if (width > height && width > maxSize) { width = maxSize; height = Math.round(maxSize / ratio); }
            else if (height >= width && height > maxSize) { height = maxSize; width = Math.round(maxSize * ratio); }
            const canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
          img.src = fr.result;
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    const productsListEl = document.getElementById('productsList');
    function newId() { return (produtos.reduce((m, p) => Math.max(m, Number(p.id) || 0), 0) || 0) + 1; }

    function renderProdutosAdmin() {
      productsListEl.innerHTML = '';
      produtos.forEach((p, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'product-item';
        wrap.dataset.index = idx;

        wrap.innerHTML = `
          <div class="product-head">
            <div class="head-title">
              <span class="badge">#${p.id}</span>
              <strong>${escapeHtml(p.nome || 'Sem Nome')}</strong>
            </div>
            <div class="head-actions">
              <button class="secondary" data-action="up"><i class="fa-solid fa-arrow-up"></i></button>
              <button class="secondary" data-action="down"><i class="fa-solid fa-arrow-down"></i></button>
              <button class="secondary" data-action="dup"><i class="fa-solid fa-clone"></i></button>
              <button class="danger" data-action="del"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>

          <div class="product-grid">
            <div>
              <div class="field">
                <label>Nome do Produto</label>
                <input data-field="nome" type="text" value="${escapeAttr(p.nome)}" placeholder="Ex: iPhone 15">
              </div>
              <div class="field">
                <label>Descri√ß√£o Curta</label>
                <input data-field="desc" type="text" value="${escapeAttr(p.desc || '')}" placeholder="Ex: 128GB Preto">
              </div>
              <div class="two-cols">
                <div class="field">
                  <label>Categoria</label>
                  <select data-field="cat">
                    <option value="aparelhos" ${p.cat === 'aparelhos' ? 'selected' : ''}>Aparelhos</option>
                    <option value="fones" ${p.cat === 'fones' ? 'selected' : ''}>Fones</option>
                    <option value="carregadores" ${p.cat === 'carregadores' ? 'selected' : ''}>Carregadores</option>
                  </select>
                </div>
                <div class="field">
                  <label>Pre√ßo</label>
                  <input data-field="preco" type="number" step="1" value="${Number(p.preco)||0}">
                </div>
              </div>
              <div class="field" style="display:flex;align-items:center;gap:10px; margin-top:5px;">
                <input id="feat_${idx}" data-field="featured" type="checkbox" style="width:20px; height:20px;" ${p.featured ? 'checked' : ''}>
                <label for="feat_${idx}" style="font-size:0.95rem; color:#fff;">Destaque (Card Grande)</label>
              </div>
            </div>

            <div>
              <div class="field">
                <label>Imagem</label>
                <div class="upload-row">
                  <input data-field="img" type="url" value="${escapeAttr(p.img || '')}" placeholder="Link da imagem (URL)">
                  <div class="upload-actions">
                    <label class="btn secondary">
                      <i class="fa-solid fa-camera"></i> Enviar Foto
                      <input type="file" accept="image/*" data-role="file" data-index="${idx}" style="display:none;">
                    </label>
                    <button class="secondary" type="button" data-action="clearImg"><i class="fa-solid fa-times"></i></button>
                  </div>
                </div>
              </div>
              <img class="img-preview" src="${escapeAttr(p.img || '')}" alt="preview" ${p.img ? '' : 'style="display:none;"'}/>
            </div>
          </div>
        `;

        wrap.addEventListener('input', onProductFieldChange);
        wrap.addEventListener('change', onProductFieldChange);

        // ‚úÖ AJUSTADO: ao deletar no painel, deleta tamb√©m no Firestore
        wrap.querySelector('[data-action="del"]').addEventListener('click', async () => {
          if (!confirm('Deletar?')) return;

          const backup = produtos[idx];
          const id = backup?.id;

          // remove da tela (r√°pido)
          produtos.splice(idx, 1);
          renderProdutosAdmin();

          // tenta deletar no Firestore
          try {
            if (!window.excluirProdutoFirestore) throw new Error("excluirProdutoFirestore indispon√≠vel");
            await window.excluirProdutoFirestore(id);
            toast("Produto exclu√≠do no Firestore!");
          } catch (e) {
            console.error(e);
            alert("Falha ao excluir no Firestore. Veja o console.");

            // desfaz na tela se falhar
            produtos.splice(idx, 0, backup);
            renderProdutosAdmin();
          }
        });

        wrap.querySelector('[data-action="dup"]').addEventListener('click', () => {
          produtos.splice(idx + 1, 0, { ...produtos[idx], id: newId(), nome: (produtos[idx].nome || '') + ' (C√≥pia)' });
          renderProdutosAdmin();
        });
        wrap.querySelector('[data-action="up"]').addEventListener('click', () => {
          if (idx > 0) { const i = produtos.splice(idx, 1)[0]; produtos.splice(idx - 1, 0, i); renderProdutosAdmin(); }
        });
        wrap.querySelector('[data-action="down"]').addEventListener('click', () => {
          if (idx < produtos.length - 1) { const i = produtos.splice(idx, 1)[0]; produtos.splice(idx + 1, 0, i); renderProdutosAdmin(); }
        });

        const fileInput = wrap.querySelector('input[type="file"]');
        const clearBtn = wrap.querySelector('[data-action="clearImg"]');
        const urlInput = wrap.querySelector('input[data-field="img"]');
        const preview = wrap.querySelector('.img-preview');

        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          try {
            const dataUrl = await fileToDataUrlCompressed(file);
            produtos[idx].img = dataUrl;
            urlInput.value = dataUrl;
            preview.src = dataUrl;
            preview.style.display = 'block';
          } catch {
            alert('Erro na imagem.');
          }
          e.target.value = '';
        });

        clearBtn.addEventListener('click', () => {
          produtos[idx].img = '';
          urlInput.value = '';
          preview.src = '';
          preview.style.display = 'none';
        });

        productsListEl.appendChild(wrap);
      });

      if (produtos.length === 0) {
        productsListEl.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Sem produtos. Adicione um!</div>';
      }
    }

    function onProductFieldChange(e) {
      const idx = Number(e.target.closest('.product-item').dataset.index);
      const field = e.target.dataset.field;
      if (!field) return;

      let val = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
      if (field === 'preco') val = Number(val) || 0;

      produtos[idx][field] = val;

      if (field === 'nome') e.target.closest('.product-item').querySelector('.head-title strong').textContent = val;
      if (field === 'img') {
        const prev = e.target.closest('.product-item').querySelector('.img-preview');
        prev.src = val; prev.style.display = val ? 'block' : 'none';
      }
    }

    // PROMO√á√ïES
    const promocoesListEl = document.getElementById('promocoesList');

    function renderPromocoesAdmin() {
      promocoesListEl.innerHTML = '';

      promocoes.forEach((p, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'promo-item';
        wrap.dataset.index = idx;

        wrap.innerHTML = `
          <div class="product-head">
            <div class="head-title"><strong>Promo√ß√£o ${idx + 1}</strong></div>
            <div class="head-actions">
              <button class="secondary" data-action="up"><i class="fa-solid fa-arrow-up"></i></button>
              <button class="secondary" data-action="down"><i class="fa-solid fa-arrow-down"></i></button>
              <button class="danger" data-action="delPromo"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>

          <div class="field">
            <label>URL da Imagem (ou DataURL)</label>
            <input data-field="url" type="url" value="${escapeAttr(p || '')}" placeholder="https://...">
            <div class="upload-actions" style="margin-top:8px;">
              <label class="btn secondary">
                <i class="fa-solid fa-camera"></i> Enviar Foto
                <input type="file" accept="image/*" data-role="promoFile" data-index="${idx}" style="display:none;">
              </label>
              <button class="secondary" type="button" data-action="clearPromoImg">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </div>

          <div>
            <img class="promo-preview" src="${escapeAttr(p || '')}" alt="promo" ${p ? '' : 'style="display:none;"'}>
          </div>
        `;

        const urlInput = wrap.querySelector('input[data-field="url"]');
        const preview = wrap.querySelector('.promo-preview');

        urlInput.addEventListener('input', () => {
          promocoes[idx] = urlInput.value;
          preview.src = urlInput.value;
          preview.style.display = urlInput.value ? 'block' : 'none';
        });

        const fileInput = wrap.querySelector('input[data-role="promoFile"]');
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;

          try {
            const dataUrl = await fileToDataUrlCompressed(file, 1200, 0.85);
            promocoes[idx] = dataUrl;
            urlInput.value = dataUrl;
            preview.src = dataUrl;
            preview.style.display = 'block';
            toast('Imagem da promo√ß√£o carregada!');
          } catch (err) {
            console.error(err);
            alert('Erro ao processar a imagem.');
          }
          e.target.value = '';
        });

        wrap.querySelector('[data-action="clearPromoImg"]').addEventListener('click', () => {
          promocoes[idx] = '';
          urlInput.value = '';
          preview.src = '';
          preview.style.display = 'none';
        });

        wrap.querySelector('[data-action="delPromo"]').addEventListener('click', () => {
          if (confirm('Deletar promo√ß√£o?')) {
            promocoes.splice(idx, 1);
            renderPromocoesAdmin();
          }
        });

        wrap.querySelector('[data-action="up"]').addEventListener('click', () => {
          if (idx > 0) {
            const it = promocoes.splice(idx, 1)[0];
            promocoes.splice(idx - 1, 0, it);
            renderPromocoesAdmin();
          }
        });

        wrap.querySelector('[data-action="down"]').addEventListener('click', () => {
          if (idx < promocoes.length - 1) {
            const it = promocoes.splice(idx, 1)[0];
            promocoes.splice(idx + 1, 0, it);
            renderPromocoesAdmin();
          }
        });

        promocoesListEl.appendChild(wrap);
      });

      if (promocoes.length === 0) {
        promocoesListEl.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Sem promo√ß√µes. Adicione uma!</div>';
      }
    }

    // PEDIDOS/COMPRAS
    const pedidosListEl = document.getElementById('pedidosList');

    function fmtMoney(n){
      const v = Number(n) || 0;
      return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function renderPedidos(pedidos) {
      pedidosListEl.innerHTML = '';

      if (!pedidos || pedidos.length === 0) {
        pedidosListEl.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Nenhuma compra encontrada.</div>';
        return;
      }

      pedidos.forEach((p) => {
        const status = (p.status || 'pendente').toLowerCase();

        let dataFormatada = "Data desconhecida";
        if (p.timestamp) {
          const dateObj = p.timestamp.seconds ? new Date(p.timestamp.seconds * 1000) : new Date(p.timestamp);
          const dia = String(dateObj.getDate()).padStart(2, '0');
          const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
          const ano = dateObj.getFullYear();
          const hora = String(dateObj.getHours()).padStart(2, '0');
          const min = String(dateObj.getMinutes()).padStart(2, '0');
          dataFormatada = `${dia}/${mes}/${ano} √†s ${hora}:${min}`;
        }

        const wrap = document.createElement('div');
        wrap.className = 'pedido-item';

        const bordaCor = status === 'atendido' ? 'var(--accent)' : '#ffb700';
        wrap.style.borderLeft = `4px solid ${bordaCor}`;

        const itensHtml = Array.isArray(p.itens) && p.itens.length
          ? p.itens.map(i => {
              const q = Number(i.quantidade) || 0;
              const preco = Number(i.preco) || 0;
              const nome = escapeHtml(i.nome || '');
              return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:4px 0;">
                        <span>${q}x ${nome}</span>
                        <span>${fmtMoney(preco * q)}</span>
                      </div>`;
            }).join('')
          : '<div>Sem itens</div>';

        wrap.innerHTML = `
          <div class="pedido-head" style="margin-bottom:10px;">
            <div>
              <strong style="font-size:1.1rem; color:#fff;">${escapeHtml(p.nome || 'Cliente')}</strong>
              <div style="font-size:0.8rem; color:#888;">üìÖ ${dataFormatada}</div>
              <div style="font-size:0.75rem; color:#666; margin-top:2px;">ID: ${escapeHtml(p.id)}</div>
            </div>
            <div class="pedido-status ${status}" style="height:fit-content;">${escapeHtml(status.toUpperCase())}</div>
          </div>

          <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-bottom:10px;">
            <div style="color:#ccc; font-size:0.9rem; margin-bottom:4px;"><i class="fa-solid fa-envelope"></i> ${escapeHtml(p.email || '-')}</div>
            <div style="color:#ccc; font-size:0.9rem; margin-bottom:4px;"><i class="fa-brands fa-whatsapp"></i> ${escapeHtml(p.telefone || '-')}</div>
            <div style="color:#ccc; font-size:0.9rem;"><i class="fa-solid fa-location-dot"></i> ${escapeHtml(p.endereco || '-')}</div>
          </div>

          <div style="margin-bottom:10px;">
            <strong style="color:var(--accent); font-size:0.9rem;">ITENS DO PEDIDO:</strong>
            <div style="font-size:0.9rem; color:#ddd; margin-top:5px;">
                ${itensHtml}
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center; background:#000; padding:10px; border-radius:6px; margin-bottom:12px;">
            <span style="color:#888;">Frete: ${p.frete_tipo || ''} (${fmtMoney(p.frete)})</span>
            <span style="font-size:1.1rem; font-weight:bold; color:var(--accent);">Total: ${fmtMoney(p.total)}</span>
          </div>

          <div style="background:#222; padding:8px; border-radius:6px; font-size:0.85rem; color:#aaa; margin-bottom:15px; text-align:center;">
            M√©todo de Pagamento: <strong style="color:#fff;">${escapeHtml(p.pagamento || '')}</strong>
          </div>

          <div style="display:flex; gap:10px;">
            ${status !== 'atendido' ?
                `<button class="secondary" style="flex:1; background:var(--accent); color:#000;" onclick="alternarStatus('${escapeAttr(p.id)}', '${status}')">
                    <i class="fa-solid fa-check"></i> Finalizar
                 </button>` :
                `<button class="secondary" style="flex:1; opacity:0.5; cursor:not-allowed;" disabled>
                    <i class="fa-solid fa-check-double"></i> Conclu√≠do
                 </button>`
            }

            <button class="danger" style="width:auto; padding:0 15px;" onclick="deletarPedido('${escapeAttr(p.id)}')">
                <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        `;

        pedidosListEl.appendChild(wrap);
      });
    }

    window.alternarStatus = async function(id, statusAtual) {
      if(!confirm('Alterar status do pedido?')) return;
      try {
        const novo = statusAtual === 'pendente' ? 'atendido' : 'pendente';
        await window.atualizarStatusFirebase(id, novo);
        toast('Status atualizado!');
        carregarPedidosNaTela();
      } catch(e) { console.error(e); }
    };

    window.deletarPedido = async function(id) {
      if(!confirm('Tem certeza? Isso apagar√° o pedido permanentemente.')) return;
      try {
        await window.excluirPedidoFirebase(id);
        toast('Pedido exclu√≠do.');
        carregarPedidosNaTela();
      } catch(e) { console.error(e); }
    };

    async function carregarPedidosNaTela() {
      const btn = document.getElementById('btnLoadPedidos');
      const icon = btn.querySelector('i');
      icon.classList.add('fa-spin');

      try {
        if(window.carregarPedidosFirebase) {
          const lista = await window.carregarPedidosFirebase();
          renderPedidos(lista);
        }
      } catch(e) {
        console.error(e);
        alert("Erro ao baixar pedidos.");
      } finally {
        icon.classList.remove('fa-spin');
      }
    }

    // =============================
    // CARREGAR DO FIRESTORE (produtos + promo√ß√µes + pagamento)
    // =============================
    async function carregarDadosDoFirestoreParaTela() {
      // 1) Produtos
      try {
        if (window.carregarProdutosFirestore) {
          const lista = await window.carregarProdutosFirestore();
          if (Array.isArray(lista) && lista.length) {
            produtos = lista.map(p => ({
              id: Number(p.id) || 0,
              nome: p.nome || '',
              cat: p.cat || 'aparelhos',
              preco: Number(p.preco) || 0,
              desc: p.desc || '',
              img: p.img || '',
              featured: !!p.featured
            }));
            renderProdutosAdmin();
          }
        }
      } catch (e) {
        console.warn('N√£o foi poss√≠vel carregar produtos do Firestore, usando localStorage.', e);
      }

      // 2) Promo√ß√µes
      try {
        if (window.carregarPromocoesFirestore) {
          const items = await window.carregarPromocoesFirestore();
          if (Array.isArray(items)) {
            promocoes = items.map(s => String(s || '').trim()).filter(Boolean);
            renderPromocoesAdmin();
          }
        }
      } catch (e) {
        console.warn('N√£o foi poss√≠vel carregar promo√ß√µes do Firestore, usando localStorage.', e);
      }

      // 3) Pagamento (credito + whatsapp)
      try {
        if (window.carregarPagamentoFirestore) {
          const pay = await window.carregarPagamentoFirestore();
          pagamento = { ...defaultPagamento, ...(pay || {}) };

          document.getElementById('credito').value = pagamento.credito || '';
          document.getElementById('whatsapp').value = pagamento.whatsapp || '';
        }
      } catch (e) {
        console.warn('N√£o foi poss√≠vel carregar pagamento do Firestore, usando localStorage.', e);
      }
    }

    // --- INICIALIZA√á√ÉO E EVENTOS ---
    document.getElementById('btnLoadPedidos').addEventListener('click', carregarPedidosNaTela);

    document.getElementById('btnAdd').addEventListener('click', () => {
      produtos.unshift({ id: newId(), nome: '', cat: 'aparelhos', preco: 0, desc: '', img: '', featured: false });
      renderProdutosAdmin();
      window.scrollTo(0, 300);
    });

    document.getElementById('btnSave').addEventListener('click', async () => {
      saveProdutosToLS();

      try {
        if (!window.salvarProdutosFirestore) throw new Error('salvarProdutosFirestore indispon√≠vel');
        await window.salvarProdutosFirestore(produtos);
        toast("Produtos salvos no Firestore!");
      } catch (e) {
        console.error(e);
        alert("Falha ao salvar produtos no Firestore. Verifique regras/permiss√£o e console.");
      }
    });

    document.getElementById('btnReset').addEventListener('click', async () => {
      if(confirm('Restaurar padr√£o?')) {
        produtos = defaultProdutos.slice();
        renderProdutosAdmin();
        saveProdutosToLS();

        try {
          if (window.salvarProdutosFirestore) {
            await window.salvarProdutosFirestore(produtos);
            toast("Produtos padr√£o enviados ao Firestore!");
          }
        } catch (e) {
          console.error(e);
        }
      }
    });

    document.getElementById('btnAddPromo').addEventListener('click', () => {
      promocoes.unshift("");
      renderPromocoesAdmin();
    });

    document.getElementById('btnSavePromo').addEventListener('click', async () => {
      savePromocoesToLS();

      pagamento.credito = document.getElementById('credito').value;
      pagamento.whatsapp = document.getElementById('whatsapp').value;

      try {
        if (!window.salvarConfigFirestore) throw new Error('salvarConfigFirestore indispon√≠vel');
        await window.salvarConfigFirestore(pagamento, promocoes);
        toast("Promo√ß√µes salvas no Firestore!");
      } catch (e) {
        console.error(e);
        alert("Falha ao salvar promo√ß√µes no Firestore.");
      }
    });

    document.getElementById('btnResetPromo').addEventListener('click', async () => {
      if(confirm('Resetar promo√ß√µes?')) {
        promocoes = defaultPromocoes.slice();
        renderPromocoesAdmin();
        savePromocoesToLS();

        pagamento.credito = document.getElementById('credito').value;
        pagamento.whatsapp = document.getElementById('whatsapp').value;

        try {
          if (window.salvarConfigFirestore) {
            await window.salvarConfigFirestore(pagamento, promocoes);
            toast("Promo√ß√µes padr√£o enviadas ao Firestore!");
          }
        } catch (e) {
          console.error(e);
        }
      }
    });

    document.getElementById('btnSavePay').addEventListener('click', async () => {
      pagamento.credito = document.getElementById('credito').value;
      pagamento.whatsapp = document.getElementById('whatsapp').value;

      savePagamentoToLS();

      try {
        if (!window.salvarConfigFirestore) throw new Error('salvarConfigFirestore indispon√≠vel');
        await window.salvarConfigFirestore(pagamento, promocoes);
        toast("Configura√ß√µes salvas no Firestore!");
      } catch (e) {
        console.error(e);
        alert("Falha ao salvar configura√ß√µes no Firestore.");
      }
    });

    document.getElementById('btnExport').addEventListener('click', () => {
      const data = { produtos, pagamento, promocoes, date: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'backup-loja-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
    });

    document.getElementById('fileImport').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = async (evt) => {
        try {
          const d = JSON.parse(evt.target.result);
          if(d.produtos) produtos = d.produtos;
          if(d.pagamento) pagamento = d.pagamento;
          if(d.promocoes) promocoes = d.promocoes;

          saveProdutosToLS();
          savePagamentoToLS();
          savePromocoesToLS();

          try {
            if (window.salvarProdutosFirestore) await window.salvarProdutosFirestore(produtos);
            if (window.salvarConfigFirestore) await window.salvarConfigFirestore(pagamento, promocoes);
            toast("Backup aplicado e enviado ao Firestore!");
          } catch (e) {
            console.error(e);
          }

          window.location.reload();
        } catch(err){
          alert('Arquivo inv√°lido');
        }
      };
      r.readAsText(f);
    });

    // FUN√á√ÉO GLOBAL DE CARREGAMENTO
    window.carregarTudo = async function() {
      // 1) carrega local (fallback)
      loadState();
      renderProdutosAdmin();
      renderPromocoesAdmin();

      if(pagamento.credito) document.getElementById('credito').value = pagamento.credito;
      if(pagamento.whatsapp) document.getElementById('whatsapp').value = pagamento.whatsapp;

      // 2) carrega do Firestore por cima (o que estiver l√° ‚Äúmanda‚Äù)
      await carregarDadosDoFirestoreParaTela();

      // 3) pedidos
      carregarPedidosNaTela();
    };

    // Render inicial
    loadState();
    renderProdutosAdmin();
    renderPromocoesAdmin();
  </script>
</body>
</html>
